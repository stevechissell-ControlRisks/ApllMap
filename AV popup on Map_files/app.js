"use strict";function isZeroCoord(t){return void 0===t||void 0===t.coordinates?!1:t.coordinates[0]===[0]&&t.coordinates[1]===[0]?!0:!1}function fadeToggle(t){var e={visible:!0,fadeSpeed:100};t=_.defaults(t,e),t.visible?($(t.panelId).fadeIn(t.fadeSpeed),$(t.hiddenStateId).fadeOut(t.fadeSpeed,function(){$(t.visibleStateId).fadeIn(t.fadeSpeed)})):($(t.panelId).fadeOut(t.fadeSpeed),$(t.visibleStateId).fadeOut(t.fadeSpeed,function(){$(t.hiddenStateId).fadeIn(t.fadeSpeed)}))}function MappyComponent(){this.defaultOptions={}}function WindyLayer(t){this.options={doneDelay:100,layerOpacity:.2,translations:{title:"Hi!!!"}},this.options=_.defaults(t,this.options),this.setDefaults(t)}function HeaderControl(t){this.options={el:"mapHeader"},void 0!==t&&(this.options=_.defaults(t,this.options)),this.setDefaults(this.options)}function MappyLayerService(){this.layers={metaData:ko.observable(),parsedLayerGroups:ko.observableArray()}}function ItemLayerGroupsService(){}function BaseLayerGroupsService(){}function RiskRatingsLegendsService(){}function OverlayGroupsService(){}function EventBus(){this.zoomend=ko.observable().extend({rateLimit:250}),this.dragend=ko.observable().extend({rateLimit:250}),this.mapResize=ko.observable().extend({rateLimit:250}),this.mapManipulated=ko.observable().extend({rateLimit:250}),this.markerOnMapClicked=ko.observable().extend({rateLimit:50}),this.serverClusterOnMapClicked=ko.observable().extend({rateLimit:100}),this.triggerZoomToMarker=ko.observable().extend({rateLimit:200}),this.openedMarker=ko.observable(-1).extend({notify:"always"}),this.openedMarkerSlug=ko.observable(-1).extend({notify:"always"}),this.riskRatingLayer=ko.observable("").extend({notify:"always"}),this.layerFiltersChanged=ko.observable({}),this.displayOnGridClicked=ko.observable("").extend({notify:"always"}),this.dateRangeChanged=ko.observable().extend({rateLimit:150}),this.minDatesFetched=ko.observable(),this.layerParsed=ko.observable(),this.layersLoading=ko.observableArray([]),this.layerLoaded=ko.observable(),this.openInNewWindow=ko.observable(),this.reportChartsRendered=ko.observableArray([]),this.gridsRendered=ko.observableArray([])}function OptionsVm(t){var e=this;this.options={dateFrom:new Date,dateTo:new Date},this.options=_.defaults(t,this.options),this.country=ko.observable(null),this.dateFrom=ko.observable(this.options.dateFrom),this.dateTo=ko.observable(this.options.dateTo),this.itemFilterGroups=ko.observableArray([]).indexBy("id"),this.dateRange=ko.computed(function(){return{dateFrom:moment(e.dateFrom()).toISOString(),dateTo:moment(e.dateTo()).toISOString()}}).extend({notify:"always",rateLimit:{timeout:400,method:"notifyWhenChangesStop"}}),this.all=ko.computed(function(){return{country:e.country(),dateFrom:moment(e.dateFrom()).toISOString(),dateTo:moment(e.dateTo()).toISOString()}}).extend({notify:"always"})}function Griddy(){this.options={}}function ItemFilterGroup(t){var e=this;this.id=t.id,this.options=t,this.name=t.name,this.layer=t.layer,this.timeless=t.layer.options.timeless||!1,this.borderCol=t.colour||"#dfdfdf",this.filters=ko.observableArray(),this.selectedFilterOptions=ko.observable().extend({rateLimit:100}),this.showOnMap=ko.observable(!1),decorateWithToggleOpenBehaviour(this),decorateWithAccordionBehaviour(this,t.accordionGroup);var o=function(){t.mappy.eventBus.layerFiltersChanged({layer:e.layer,showOnMap:e.showOnMap(),filterOptions:e._getSelectedFilterOptions()})};e.showOnMap.subscribe(function(){t.mappy.options.onLayerSelected&&t.mappy.options.onLayerSelected(e.id,{showOnMap:e.showOnMap(),layer:e.layer}),o()}),e.selectedFilterOptions.subscribe(function(){e.showOnMap()&&o()}),t.mappy.eventBus.dateRangeChanged.subscribe(function(){e.showOnMap()&&o()})}function ItemFilters(t){this.options={el:"itemFilters",translations:{viewOnGrid:"View Details",clearAll:"Clear All",generateReport:"Generate Report",generateReportBaseUrl:"#"}},this.options=_.defaults(t,this.options),this.setDefaults(t),this.itemLayers=ko.observableArray()}function ControlsPanel(t){var e=this;this.options={el:"controlsPanel",fadeSpeed:100,translations:{title:"Tools"}},void 0!==t&&(this.options=_.defaults(t,this.options)),this.setDefaults(this.options),e.openState=ko.observable(1),e.openState.subscribe(function(t){t?($("#controlsPanel").addClass("openState1").removeClass("openState0"),$("#controlsPanel .crPanelSection").fadeIn()):($("#controlsPanel").addClass("openState0").removeClass("openState1"),$("#controlsPanel .crPanelSection").fadeOut())}),e.openState(1),e.isOpen=ko.computed(function(){return e.openState()>0}),this.toggleOpen=function(){e.openState(e.isOpen()?0:1)},this.elOffsetWidth=this.$el[0].offsetWidth,this.$el.resize(_.debounce(function(){e._padScrollBar()},50)),this.scrollPadded=!1,this._disableMouseWheelMapZoomOnPanelHover()}function DateControl(t){this.options={el:"dateSliderPanel"},this.options=_.defaults(t,this.options),this.setDefaults(t)}function ZoomControl(t){this.options={el:"zoomControl"},this.options=_.defaults(t,this.options),this.inFullScreen=ko.observable(!1),this.fullScreenStatus=ko.computed(function(){return this.inFullScreen()?"fullScreenOn":"fullScreenOff"},this)}function ReportControl(t){this.options={el:"reportControl",generateReportBaseUrl:"/report-map.html",translations:{generateReport:"Generate Report Translatable"}},this.options=_.defaults(t,this.options)}function GeocoderControl(t){this.options={el:"geocoderControl",keepOpen:!0,translations:{searchLabel:"Search..."}},this.options=_.defaults(t,this.options),this.setDefaults(t)}function MapScaleControl(t){this.options={el:"mapScaleControl",keepOpen:!0,translations:{searchLabel:"Scale..."}},this.options=_.defaults(t,this.options),this.setDefaults(t)}function RiskRatingsPanel(t){var e=function(t){this.availableOverlays=ko.observableArray(),this.selectedOverlay=ko.observable({}),window.decorateWithToggleOpenBehaviour(this),window.decorateWithAccordionBehaviour(this,t.accordionGroup),this.title=""};this.options={el:"riskRatingsPanel",riskRatingsPanelVm:new e(t),translations:{emptyOverlayOptionName:"None",title:"Risk Ratings"}},this.options=_.defaults(t,this.options),this.setDefaults(t),this.overlayGroups=ko.observableArray()}function BaseLayersPanel(t){this.options={el:"baseLayerPanel"},this.options=_.defaults(t,this.options),this.setDefaults(t),this.baseLayerGroups=ko.observableArray(),this.defaultLayer=ko.observable()}function NewsPanel(t){this.options={el:"newsPanel",toggleSpeed:100,margin:{top:50,bottom:150}},this.options=_.defaults(t,this.options),this.setDefaults(t),this.panelIsVisible=!0}function Mappy(t){var e=this;this.options=t,this.layers={};var o=t.mapDefault.centerLat,i=t.mapDefault.centerLng,n=t.mapDefault.zoom;this.eventBus=new window.EventBus,this.layerServices=this.options.layerServices,this.components=this.options.components;var a=getParameterByName("mappyCompressed");if(a){a=a.replace(/(.{2})/g,"$& ");var s=window.convertFormatedHexToBytes(a);LZMA.decompress(s,function(a){e.mappyState=$.parseJSON(a),e.mappyState.dateFilterSetting&&(t.initialDateFrom=moment(e.mappyState.dateFilterSetting.dateFrom).toDate(),t.initialDateTo=moment(e.mappyState.dateFilterSetting.dateTo).toDate()),e.mappyState.mapSetting&&(o=e.mappyState.mapSetting.centerLat,i=e.mappyState.mapSetting.centerLng,n=e.mappyState.mapSetting.zoom),e._initMap(o,i,n)}),this.isHistory=!0}else e.mappyState={gridSettings:{},itemFilterSetting:{}},e._initMap(o,i,n)}function clearHighlightMarker(){void 0!==hm&&window.map.removeLayer(hm)}function highlightMarker(t){if(void 0!==t){clearHighlightMarker();var e="highlightCircleMarker";hm=L.circleMarker(t._latlng,{_leaflet_id:e}),window.map.addLayer(hm)}}function RightPanel(t){this.options={},$.extend(!0,this.options,{el:"rightPanel",translations:{title:"Latest News Translated",reportTitle:"Political Violence Incident Report: Detailed View"}},t),this.panelSections=ko.observableArray(),this.openState=ko.observable(1)}function GridControl2(t){this.options={el:"gridControl",displayGridOnInit:!0,pageSize:10},this.options=_.defaults(t,this.options),this.setDefaults(t),this.gridOptionsDictionary=ko.observableArray([]).indexBy("id"),this.type="GridControl2"}function ChartsControl(t){this.options={el:"chartsControl",charts:[],translations:{analytics:"Analytics",disclaimerLinkText:"",disclaimerLinkUri:""}},this.options=_.defaults(t,this.options),this.setDefaults(this.options),Modernizr.inlinesvg&&(this.openState=ko.observable(0),this.blownUpChart=ko.observable(null),this._chartDivs={})}function ReportChartsControl(t){this.options={el:"reportChartsControl",height:400,charts:[],translations:{analytics:"Analytics",disclaimerLinkText:"",disclaimerLinkUri:"",titleText:""}},this.options=_.defaults(t,this.options),this.setDefaults(this.options),Modernizr.inlinesvg&&(this.blownUpChart=ko.observable(null))}function RiskRatingsLegends(t){this.options={el:"riskRatingsLegends"},this.options=_.defaults(t,this.options),this.setDefaults(t),this.riskRatingsLegends=ko.observableArray()}function ReportLegends(t){this.options={el:"reportLegends",translations:{terrorism:"",war:"",unrest:"",multiple:"",asset:""}},this.options=_.defaults(t,this.options)}function MappyChartComponent(){this.chartDataDictionary=ko.observableArray([]).indexBy("id"),this.chartData=ko.observableArray([]),this.chartContent={}}function ChartDateHistogramIncidentsByField(t){Modernizr.inlinesvg&&(this.options={slug:"",type:"",bindTo:"",dataUrl:"",parameters:{interval:"",field:"",excludeFields:[],dateFrom:"",dateTo:""},translations:{title:"",shortTitle:""},rotation:-60,tickPadding:6},this.options=_.defaults(t,this.options))}function ChartIncidentsByField(t){Modernizr.inlinesvg&&(this.options={slug:"",type:"",bindTo:"",dataUrl:"",isForReport:!1,parameters:{field:"",dateFrom:"",dateTo:""},translations:{title:"",shortTitle:"",others:"Others",unknown:"Unknown"},showTop:9,legendHeightRatio:.7,marginLeft:0},this.options=_.defaults(t,this.options))}function ChartIncidentsByFieldByField(t){Modernizr.inlinesvg&&(this.options={slug:"",type:"",bindTo:"",dataUrl:"",parameters:{field1:"",field2:"",dateFrom:"",dateTo:""},translations:{title:"",shortTitle:"",others:"Others",unknown:"Unknown"},showTop:10,legendHeightRatio:1,rotation:-60,tickPadding:6},this.options=_.defaults(t,this.options))}function ReportCover(t){this.options={el:"mapReportCover",contactemail:"",slug:"aimPoliticalIncidents",translations:{search:"Search",countries:"Countries",regions:"Regions",categories:"Categories",sectors:"Sectors",assettypes:"Asset Types",attacktypes:"Attack Types",damagevalue:"Damage Value",severityscore:"Severity Score",perpetrators:"Perpetrators",riskratings:"Risk Ratings",covertitle:"Political Violence Incident Report",fromlabel:"From",tolabel:"To",footerlabel:""}},this.options=_.defaults(t,this.options)}function ReportMapHeaderPanel(t){this.options={el:"mappyReportHeader",translations:{title:""}},this.options=_.defaults(t,this.options)}var addSpinner=function(t,e){this.options={lines:8,length:5,width:3,radius:5,corners:0,rotate:0,direction:1,color:"#053747",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"50%",left:"50%"},this.options=_.defaults(t,this.options),new window.Spinner(this.options).spin(e[0])},addMarker=function(t){return this.options={iconUrl:"marker.png",shadowUrl:"marker-shadow.png",iconSize:[47,40],shadowSize:[50,64],iconAnchor:[21,39],shadowAnchor:[6,55],popupAnchor:[-3,-76]},this.options=_.defaults(t,this.options),new L.icon(this.options)},decorateWithToggleOpenBehaviour=function(t){t.open=ko.observable(!1),t.toggleOpen=function(){t.open(!t.open())}},decorateWithAccordionBehaviour=function(t,e){var o=t.toggleOpen;t.toggleOpen=function(){o(),$(document).trigger("accordionChange",{sender:t,accordionGroup:e})},$(document).on("accordionChange",function(o,i){i.accordionGroup===e&&i.sender!==t&&i.sender.open()&&t.open(!1)})};ko.bindingHandlers.slideDownVisible={init:function(t,e){var o=e();$(t).toggle(ko.unwrap(o))},update:function(t,e){var o=e();ko.unwrap(o)?$(t).slideDown():$(t).slideUp()}},ko.bindingHandlers.switchClass={init:function(t,e){var o=ko.utils.unwrapObservable(e());$(t).addClass(o)},update:function(t,e){var o=ko.utils.unwrapObservable(e());o=String(o||"");var i=t.prevCssValue;t.prevCssValue=o;var n=function(){};if("openState1"===i&&"openState2"===o){var a=$(t).offset();return void $(t).css("left",a.left+"px").animate({left:"300px",width:a.left+"300px"},function(){$(t).css("left","").css("width","").removeClass(i).addClass(o)})}return"openState2"===i&&"openState1"===o?void $(t).css("width",$("body").width()-$(t).offset().left+"px").css("right","0px").css("left","inherit").animate({width:"220px"},function(){$(t).css("width","").css("right","").css("left","").removeClass(i).addClass(o)}):void $(t).css("width","").switchClass(i,o,"easeInOutQuad",n)}},ko.bindingHandlers.toggleSrc={init:function(t,e){var o=e(),i=$(t);i.data("orig-src",i.attr("src")),$(t).attr("src",i.data(ko.unwrap(o)?"orig-src":"alt-src"))},update:function(t,e){var o=e(),i=$(t);i.attr("src",i.data(ko.unwrap(o)?"orig-src":"alt-src"))}},ko.bindingHandlers.select2={init:function(t,e,o){var i=e(),n=o(),a=n.lookupKey;if(setTimeout(function(){$(t).select2(i)},0),a){var s=ko.utils.unwrapObservable(n.value);$(t).select2("data",ko.utils.arrayFirst(i.data.results,function(t){return t[a]===s}))}ko.utils.domNodeDisposal.addDisposeCallback(t,function(){$(t).select2("destroy")})},update:function(t,e,o){var i=o(),n=ko.utils.unwrapObservable(i.selectedOptions);$(t).select2("val",n),$(t).trigger("change")}},ko.bindingHandlers.textOrHtml={init:function(){return{controlsDescendantBindings:!0}},update:function(t,e,o,i,n){n.$data.isHtml?ko.bindingHandlers.html.update(t,e,o,i,n):ko.bindingHandlers.text.update(t,e,o,i,n)}},function(){Date.prototype.toISOString||(Date.prototype.toISOString=function(){var t=function(t){return 10>t?"0"+t:t};return this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z"})}(),ko.observable.fn.withPausing=function(){return this.notifySubscribers=function(){this.pauseNotifications||ko.subscribable.fn.notifySubscribers.apply(this,arguments)},this.sneakyUpdate=function(t){this.pauseNotifications=!0,this(t),this.pauseNotifications=!1},this},window.convertToFormattedHex=function(t){var e,o,i,n="";for(o=t.length,e=0;o>e;++e)t[e]<0&&(t[e]=t[e]+256),i=t[e].toString(16),1===i.length&&(i="0"+i),i+=(e+1)%16===0?"\n":" ",n+=i;return n.trim()},window.convertFormatedHexToBytes=function(t){var e,o,i,n=0,a=[];if(""===t.trim())return[];if(/[^0-9a-fA-F\s]/.test(t))return!1;for(e=t.split(/([0-9a-fA-F]+)/g),o=e.length,i=0;o>i;++i)""!==e[i].trim()&&(a[n++]=parseInt(e[i],16));return a},MappyComponent.prototype.setDefaults=function(t){void 0!==t&&(this.$el=$(document.getElementById(this.options.el)),this.elInitialWidth=this.$el.width())},MappyComponent.prototype._disableMouseWheelMapZoomOnPanelHover=function(){this.$el.on("mouseover",function(){window.map.scrollWheelZoom.disable(),window.map.doubleClickZoom.disable(),window.map.dragging.disable()}),this.$el.on("mouseout",function(){window.map.scrollWheelZoom.enable(),window.map.doubleClickZoom.enable(),window.map.dragging.enable()})},MappyComponent.prototype._setElementId=function(t){this.$el=$(document.getElementById(t))},WindyLayer.prototype=new MappyComponent,WindyLayer.prototype.initialize=function(t,e){var o=L.tileLayer("http://{s}.tile.openweathermap.org/map/wind/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openweathermap.org">OpenWeatherMap</a>',opacity:this.options.layerOpacity});window.map.addLayer(o),t.optionsVm.all.subscribe(function(t){}),_.delay(function(){e()},this.options.doneDelay)},WindyLayer.prototype.initialized=function(){},HeaderControl.prototype=new MappyComponent,HeaderControl.prototype.initialize=function(){this._disableMouseWheelMapZoomOnPanelHover()},MappyLayerService.prototype=new MappyComponent,MappyLayerService.prototype.getLayerGroups=function(t,e){var o=this;$.ajax({dataType:"json",url:t,success:function(t){o._parseLayerGroups(t,e)},error:function(){}})},MappyLayerService.prototype._parseLayerGroups=function(t,e){var o=this;o.layers.metaData(t),_.each(t,function(t){var e=o._parseLayerGroup(t);o.layers.parsedLayerGroups.push(e)}),e()},MappyLayerService.prototype._parseWmsTileLayer=function(t){return L.tileLayer.wms(t.url,{layers:t.options.layers,format:t.options.format,version:t.options.version,transparent:t.options.transparent,opacity:t.options.opacity,minZoom:t.options.minZoom,maxZoom:t.options.maxZoom,subdomains:t.options.subdomains,reuseTiles:!0,updateWhenIdle:!0,continuousWorld:!1,detectRetina:!1,tiled:!0})},MappyLayerService.prototype._parseTileLayer=function(t){return L.tileLayer(t.url,{opacity:t.options.opacity,minZoom:t.options.minZoom,maxZoom:t.options.maxZoom})},MappyLayerService.prototype._parseMapboxLayer=function(t){var e=L.mapbox.tileLayer(t.url),o=this;return e.on("load",function(t){o.mappy.eventBus.layerLoaded(t)}),e},MappyLayerService.prototype._parseItemLayer=function(t){return L.itemsLayerGroup({name:t.options.slug,url:t.url,optionsVm:this.optionsVm,markerIconsDictionary:this._buildMarkerIconsDictionary(t),colour:t.options.colour})},MappyLayerService.prototype._parseItem2Layer=function(t){return L.items2LayerGroup({mappy:this.mappy,layer:t})},MappyLayerService.prototype._parseLayerGroup=function(t){var e=L.layerGroup();e.name=t.name;for(var o in t.layers){var i=t.layers[o];switch(i.type){case"wms":e.addLayer(this._parseWmsTileLayer(i),i.name);break;case"tile":e.addLayer(this._parseTileLayer(i),i.name);break;case"mapbox":e.addLayer(this._parseMapboxLayer(i),i.name);break;case"item":break;case"item2":e.addLayer(this._parseItem2Layer(i),i.name)}this.mappy.eventBus.layerParsed(i)}return e},MappyLayerService.prototype._buildMarkerIconsDictionary=function(t){var e=t.options.markerIcons;if(void 0===e)return null;var o=ko.observableArray([]).indexBy("id");return _.each(e,function(t){var e={iconUrl:t.iconUrl,shadowUrl:t.shadowUrl};o.push({id:t.name,object:window.addMarker(e)})}),o},ItemLayerGroupsService.prototype=new MappyLayerService,ItemLayerGroupsService.prototype.initialize=function(t,e,o){var i=this;i.options=e,i.optionsVm=t.optionsVm,i.getLayerGroups(i.options.url,function(){i._getLayersMinDates(o)})},ItemLayerGroupsService.prototype.initialized=function(){var t=this;t._addDefaultLayers()},ItemLayerGroupsService.prototype._addDefaultLayers=function(){var t=this;_.each(t.layers.parsedLayerGroups(),function(e){_.contains(t.options.initialLoad,e.name)&&window.map.addLayer(e)})},ItemLayerGroupsService.prototype._getLayersMinDates=function(t){var e=this,o=e.mappy.options.parametersBaseUrl+"layersMinDate";$.ajax({url:o,type:"get",success:function(t){e.mappy.eventBus.minDatesFetched(t)},error:function(t){},complete:function(){t()}})},BaseLayerGroupsService.prototype=new MappyLayerService,BaseLayerGroupsService.prototype.initialize=function(t,e,o){var i=this;i.mappy=t,i.options=e,i._initBaseLayers(o)},BaseLayerGroupsService.prototype.initialized=function(){},BaseLayerGroupsService.prototype._initBaseLayers=function(t){var e=this,o=e.options.defaultLayer;e.mappy.mappyState.baseLayer&&(o=e.mappy.mappyState.baseLayer),e.getLayerGroups(e.options.url,function(){window.bb=e.layers;var i=_.find(e.layers.parsedLayerGroups(),{name:o});i.setZIndex(1),window.map.addLayer(i),window.L.mapbox.tileLayer("batdev.c26db78c",{zIndex:100}).addTo(window.map),t()})},RiskRatingsLegendsService.prototype=new MappyLayerService,RiskRatingsLegendsService.prototype.initialize=function(t,e,o){var i=this;i.options=e,i.parsedLegends=ko.observableArray(),i._initRiskRatings(o)},RiskRatingsLegendsService.prototype.initialized=function(){},RiskRatingsLegendsService.prototype._initRiskRatings=function(t){var e=this;$.ajax({dataType:"json",url:e.options.url,success:function(t){_.forEach(t,function(t){e.parsedLegends.push(t)})}}),t()},OverlayGroupsService.prototype=new MappyLayerService,OverlayGroupsService.prototype.initialize=function(t,e,o){var i=this;i.options=e,i._initOverlays(o),o()},OverlayGroupsService.prototype.initialized=function(){},OverlayGroupsService.prototype._initOverlays=function(t){var e=this;e.getLayerGroups(e.options.url,function(){if(window.bb=e.layers,void 0!==e.options.defaultStaticLayer){var o=_.find(e.layers.parsedLayerGroups(),{name:e.options.defaultStaticLayer});o.setZIndex(10),window.map.addLayer(o)}t()})},EventBus.prototype.startLayerLoad=function(t){var e=_.find(this.layersLoading(),function(e){return t.options.slug===e.options.slug});e||this.layersLoading.push(t)},EventBus.prototype.finishLayerLoad=function(t){var e=_.find(this.layersLoading(),function(t){return t.options.slug===t.options.slug});e&&this.layersLoading.remove(t)},Griddy.prototype=new MappyComponent,Griddy.prototype.initialize=function(t,e){e()},ItemFilterGroup.prototype._getSelectedFilterOptions=function(){var t=this.options.mappy.optionsVm,e={};if(this.timeless===!1){var o,i;if(void 0!==this.options.mappy.mappyState&&void 0!==this.options.mappy.mappyState.dateFilterSetting&&void 0===this.options.mappy.isHistory){var n=new Date(this.options.mappy.mappyState.dateFilterSetting.dateFrom),a=new Date(this.options.mappy.mappyState.dateFilterSetting.dateTo);o=moment.utc(new Date(n.getTime()+6e4*n.getTimezoneOffset()+36e5*this.options.mappy.mappyState.clientTimezone)),i=moment.utc(new Date(a.getTime()+6e4*a.getTimezoneOffset()+36e5*this.options.mappy.mappyState.clientTimezone))}else o=moment.utc(t.dateFrom()),i=moment.utc(t.dateTo()),o.subtract("m",t.dateFrom().getTimezoneOffset()),i.subtract("m",t.dateTo().getTimezoneOffset());o.startOf("day"),i.endOf("day"),_.merge(e,{dateFrom:o.toISOString(),dateTo:i.toISOString()})}var s=this.selectedFilterOptions();return void 0!==s&&_.merge(e,s),e},ItemFilters.prototype=new MappyComponent,ItemFilters.prototype.initialize=function(t,e){var o=this;o.mappy=t,this.viewOnGrid=this.options.translations.viewOnGrid,this.clearAllTxt=this.options.translations.clearAll,this.generateReport=this.options.translations.generateReport,this.generateReportBaseUrl=this.options.translations.generateReportBaseUrl,void 0!==t.options.layerServices.itemLayerGroups&&(this.service=t.options.layerServices.itemLayerGroups,o.optionsVm=t.optionsVm,o._setupEvents(),ko.applyBindings(this,document.getElementById(o.options.el)),e())},ItemFilters.prototype.initialized=function(){},ItemFilters.prototype._setupEvents=function(){var t=this;t.mappy.eventBus.layerParsed.subscribe(function(e){t._buildItemFilterGroups(e)})},ItemFilters.prototype._buildItemFilterGroups=function(t){var e=this;if(void 0!==t.options&&null!==t.options){var o=t.options.filters;if(void 0!==o&&null!==o){var i=new ItemFilterGroup({id:t.options.slug,name:t.name,colour:t.options.colour,timeless:t.options.timeless,accordionGroup:"leftpanel",mappy:e.mappy,layer:t}),n=e.mappy.mappyState.itemFilterSetting[i.id];i.filters(e._buildFiltersFromLayerFilterOptions(t.options.slug,o,n)),e.optionsVm.itemFilterGroups.push({id:i.id,object:i});var a=_.contains(e.options.initialLoad,t.options.slug);n&&(a=n.showOnMap,n.selectedOptions&&i.selectedFilterOptions(n.selectedOptions)),a&&i.showOnMap(!0),e._bindSelectedOptionsToFilterChange(i)}}},ItemFilters.prototype._buildFiltersFromLayerFilterOptions=function(t,e,o){var i=[],n=0;return _.each(e,function(e){var a={id:e.slug,type:e.type,name:e.name,values:e.values,selectedOptions:ko.observableArray(),placeholder:e.placeholder,iconUrl:e.iconUrl,searchTextValue:ko.observable(""),uniqueElementId:"secretId_"+t+"_"+n};if(o&&o.selectedOptions)if("freeText"===a.type){var s=o.selectedOptions["search."+a.id];s&&a.searchTextValue(s)}else{var r=o.selectedOptions["filters."+a.id];r&&a.selectedOptions(r)}i.push(a),n++}),i},ItemFilters.prototype._bindSelectedOptionsToFilterChange=function(t){_.each(t.filters(),function(e){e.selectedOptions.subscribe(function(){var e={};_.each(t.filters(),function(t){"freeText"!==t.type?e["filters."+t.id]=t.selectedOptions():t.searchTextValue().length>0&&(e["search."+t.id]=t.searchTextValue())}),t.selectedFilterOptions(e)},null,"change"),e.searchTextValue.subscribe(function(){var e={};_.each(t.filters(),function(t){"freeText"!==t.type?e["filters."+t.id]=t.selectedOptions():e["search."+t.id]=t.searchTextValue()}),t.selectedFilterOptions(e)},null,"change")})},ItemFilters.prototype.clearAll=function(){this.object.filters().forEach(function(t){"multiple"===t.type?t.selectedOptions.removeAll():"freeText"===t.type&&($("#s2id_"+t.uniqueElementId).select2("val",""),t.searchTextValue(""))})},ItemFilters.prototype.displayOnGrid=function(){this.object.options.mappy.eventBus.displayOnGridClicked(this.object.layer.options.slug)},ControlsPanel.prototype=new MappyComponent,ControlsPanel.prototype._padScrollBar=function(){var t=this;if(1!==this.openState())return this.$el.css("width",""),void(this.scrollPadded=!1);var e=this.$el[0].offsetWidth-this.$el[0].clientWidth;e>0?this.scrollPadded||(9===t.mappy.isIE()?this.$el.width(this.elOffsetWidth+this.mappy.browserScrollBarWidth+5):this.$el.width(this.elOffsetWidth+this.mappy.browserScrollBarWidth-5),this.scrollPadded=!0):this.scrollPadded&&(this.$el.css("width",""),this.scrollPadded=!1)},ControlsPanel.prototype.initialize=function(t,e){var o=this;o.mappy=t,$("#"+o.options.el).css("max-height",t.viewableHeight()),t.$mapEl.resize(function(){$("#"+o.options.el).css("max-height",t.viewableHeight())}),this._setLabels(),ko.applyBindings(this,this.$el.find(".crPanelHeader")[0]),e()},ControlsPanel.prototype._setLabels=function(){this.title=this.options.translations.title},DateControl.prototype=new MappyComponent,DateControl.prototype._layerMinDates={minDates:[],getMinDate:function(){for(var t=new Date,e=0;e<this.minDates.length;e++)this.minDates[e].visible&&this.minDates[e].minDate<t&&(t=this.minDates[e].minDate);return t}},DateControl.prototype.initialize=function(t,e){var o=this;o.mappy=t,t.options.el=o.options.el,$.extend(o.options,t.options),this.optionsVm=t.optionsVm,o.options.initialDateFrom=o._formatDate(o.options.initialDateFrom),o.options.initialDateTo=o._formatDate(o.options.initialDateTo),o.options.minDate=o._formatDate(o.options.minDate),o.options.maxDate=o._formatDate(o.options.maxDate),o.options.totalMonths=this._monthDiff(o.options.minDate,o.options.maxDate),o._setLanguage(this.optionsVm),o._initDatePicker(t);var i=this.optionsVm.dateFrom(),n=this.optionsVm.dateTo(),a=i.getFullYear()===n.getFullYear()&&i.getMonth()===n.getMonth();o._initDateSlider(o.options.minDate,o.options.maxDate,o.options.totalMonths,a),o._onFromDateChanged(o.options.minDate),ko.applyBindings(this.optionsVm,document.getElementById(o.options.el)),o._disableMouseWheelMapZoomOnPanelHover(),e(),t.eventBus.minDatesFetched.subscribe(function(t){for(var e=0;e<t.length;e++)o._layerMinDates.minDates.push({name:t[e].name,minDate:moment(t[e].minDate,"DD-MM-YYYY").toDate(),visible:!0});var i=o._layerMinDates.getMinDate();o._changeMinDate(i)}),t.eventBus.layerFiltersChanged.subscribe(function(t){for(var e=0;e<o._layerMinDates.minDates.length;e++)if(o._layerMinDates.minDates[e].name===t.layer.name){o._layerMinDates.minDates[e].visible=t.showOnMap;break}if(o._layerMinDates.minDates.length>0){var i=o._layerMinDates.getMinDate();o._changeMinDate(i)}})},DateControl.prototype._fireDateChangeEvent=function(){var t=this,e={dateFrom:moment(t.optionsVm.dateFrom()).toISOString(),dateTo:moment(t.optionsVm.dateTo()).toISOString()};t.mappy.eventBus.dateRangeChanged(e)},DateControl.prototype._initDatePicker=function(){var t=this,e=t.optionsVm;$(".datePicker").datepick({dateFormat:"dd/mm/yyyy",minDate:t.options.minDate,maxDate:t.options.maxDate,autoSize:!0,constrainInput:!0,renderer:$.extend({},$.datepick.defaultRenderer,{picker:'<div class="datepick"><button type="button" title="'+t.mappy.options.translations.closeTheDatePicker+'"" class="datepick-cmd datepick-cmd-close ">Close</button>{months}{popup:start}<div class="datepick-nav">{link:prev}{link:today}{link:next}</div>{popup:end}<div class="datepick-clear-fix"></div></div>'}),onSelect:function(o){var i=t._formatDate(o),n=!0;$(this).hasClass("datePickerFrom")?(e.dateFrom(i),t._dayDiff(i,e.dateTo())>t.options.maxDateRange&&e.dateTo(moment(i).add(t.options.maxDateRange,"days").toDate())):$(this).hasClass("datePickerTo")&&(e.dateTo(i),t._dayDiff(e.dateFrom(),i)>t.options.maxDateRange&&e.dateFrom(moment(e.dateFrom()).add(t.options.maxDateRange,"days").toDate())),n&&($(this).hasClass("datePickerTo")?t._onFromDateChanged(i):$(this).hasClass("datePickerFrom")&&t._onToDateChanged(i)),t._fireDateChangeEvent()}})},DateControl.prototype._onFromDateChanged=function(t){var e=this,o=e.optionsVm;o.dateTo()>t&&(t=o.dateTo()),moment(o.dateFrom()).year()!==moment(t).year()?($("#slider").attr("state","years"),e._recreateSlider(e.options.minDate,e.options.maxDate)):moment(o.dateFrom()).month()!==moment(t).month()?($("#slider").attr("state","months"),e._recreateSliderToMonths(moment(t).format("YYYY"))):($("#slider").attr("state","days"),e._recreateSliderToDays(moment(t).month(),moment(t).format("YYYY"))),$("#slider").dateRangeSlider("values",o.dateFrom(),o.dateTo())},DateControl.prototype._onToDateChanged=function(t){var e=this,o=e.optionsVm;moment(t).year()!==moment(o.dateTo()).year()?($("#slider").attr("state","years"),e._recreateSlider(e.options.minDate,e.options.maxDate)):moment(o.dateTo()).month()!==moment(t).month()?($("#slider").attr("state","months"),e._recreateSliderToMonths(moment(t).format("YYYY"))):($("#slider").attr("state","days"),e._recreateSliderToDays(moment(t).month(),moment(t).format("YYYY"))),$("#slider").dateRangeSlider("values",o.dateFrom(),o.dateTo())},DateControl.prototype._initDateSlider=function(t,e,o,i){var n=this,a=n.optionsVm;t=void 0!==t?t:n.options.minDate,e=void 0!==e?e:n.options.maxDate,o=void 0!==o?o:n.options.totalMonths;var s=o>12?"YYYY":i?"DD":"MMM",r=o>12?"years":i?"days":"months",p=n.options.initialDateFrom<t?t:n.options.initialDateFrom;$("#slider").dateRangeSlider({bounds:{min:t,max:window.moment(e).add("days",1).add("ms",-1)},defaultValues:{min:p,max:n.options.initialDateTo},range:{min:!1,max:{days:n.options.maxDateRange}},scales:[{first:function(t){return o>12?window.moment(t).add("years",1).month(0).date(1):window.moment(t).date()>1?window.moment(t).add("months",1).date(1):i?window.moment(t).add("days",1).date(1):window.moment(t)},next:function(t){return window.moment(t).add(r,1)},label:function(t){return window.moment(t).format(s)}}],valueLabels:"change",delayOut:4e3,formatter:function(t){return window.moment(t).format("DD/MM/YYYY")}}),$("#slider").bind("valuesChanged",function(t,e){var o=n._formatDate(e.values.min),i=n._formatDate(e.values.max);(a.dateFrom().getTime()!==o.getTime()||a.dateTo().getTime()!==i.getTime())&&(a.dateFrom().getTime()!==o.getTime()&&a.dateFrom(o),a.dateTo().getTime()!==i.getTime()&&a.dateTo(i),moment(o).year()===moment(i).year()&&moment($("#slider").dateRangeSlider("bounds").min).year()!==moment($("#slider").dateRangeSlider("bounds").max).year()&&($("#slider").attr("state","months"),n._recreateSliderToMonths(moment(o).year()),$("#slider").dateRangeSlider("values",a.dateFrom(),a.dateTo())),moment(o).month()===moment(i).month()&&moment(o).year()===moment(i).year()&&moment($("#slider").dateRangeSlider("bounds").min).format("MM/YYYY")!==moment($("#slider").dateRangeSlider("bounds").max).format("MM/YYYY")&&($("#slider").attr("state","days"),n._recreateSliderToDays(moment(o).month(),moment(o).year()),$("#slider").dateRangeSlider("values",a.dateFrom(),a.dateTo())),n._fireDateChangeEvent())})},DateControl.prototype._setLanguage=function(t){t.fromText=this.options.translations.from,t.toText=this.options.translations.to,void 0===this.options.language?window.moment.lang("en"):window.moment.lang(this.options.language)},DateControl.prototype._getDateArray=function(t,e,o,i){t=t||Date.prototype.addDays,e=e||1;for(var n=[],a=this._formatDate(o),s=this._formatDate(i);s>=a;)n.push(new Date(a)),
a=t.call(a,e);return n},DateControl.prototype._getIndexFromDateArray=function(t,e){var o=this._formatDate(t);if(null===o||null===e)return 0;for(var i=0;i<e.length;i++){var n=e[i];if(n.getTime()===o.getTime())return i}return 0},DateControl.prototype._dayDiff=function(t,e){var o=864e5,i=Math.abs((t.getTime()-e.getTime())/o);return i},DateControl.prototype._monthDiff=function(t,e){var o;return o=12*(e.getFullYear()-t.getFullYear()),o-=t.getMonth()+1,o+=e.getMonth(),0>=o?0:o},DateControl.prototype._formatDate=function(t){var e=new Date(t);return e.setHours(0,0,0,0),e},DateControl.prototype._changeMinDate=function(t){this.options.minDate!==t&&(this.options.minDate=t,this._onFromDateChanged(t),$(".datePicker").datepick("option",{minDate:t}))},DateControl.prototype._recreateSliderToMonths=function(t){var e=new Date(t,0,1),o=new Date(t,11,31);this._recreateSlider(e,o)},DateControl.prototype._recreateSliderToDays=function(t,e){var o=new Date(e,t,1),i=new Date(moment(o).endOf("month"));this._recreateSlider(o,i,!0)},DateControl.prototype._recreateSlider=function(t,e,o){var i=this;$("#slider").dateRangeSlider("destroy"),i._initDateSlider(i._formatDate(t),i._formatDate(e),i._monthDiff(t,e),o)},ZoomControl.prototype=new MappyComponent,ZoomControl.prototype.initialize=function(t,e){this.mapDefault=t.options.mapDefault,ko.applyBindings(this,document.getElementById(this.options.el)),this._setTranslations(),this._bindEscapeToExitFullScreen(),e()},ZoomControl.prototype._setTranslations=function(){if(void 0!==this.options.translations){var t=$(document.getElementById(this.options.el));void 0!==this.options.translations.defaultView&&t.children(".resetView").text(this.options.translations.defaultView)}},ZoomControl.prototype.zoomIn=function(){window.map.zoomIn()},ZoomControl.prototype.zoomOut=function(){window.map.zoomOut()},ZoomControl.prototype.fullScreenClick=function(){this.inFullScreen()?this.exitFullScreen():this.enterFullScreen()},ZoomControl.prototype.enterFullScreen=function(){this.inFullScreen()||(_.isFunction(this.options.onFullScreen)&&(this.options.onFullScreen(),window.map.invalidateSize()),this.inFullScreen(!this.inFullScreen()))},ZoomControl.prototype.exitFullScreen=function(){this.inFullScreen()&&(_.isFunction(this.options.onExitFullScreen)&&this.options.onExitFullScreen(),this.inFullScreen(!this.inFullScreen()))},ZoomControl.prototype._bindEscapeToExitFullScreen=function(){var t=this;$(document).keyup(function(e){27===e.keyCode&&t.exitFullScreen()})},ZoomControl.prototype.resetView=function(){window.map.setView([this.mapDefault.centerLat,this.mapDefault.centerLng],this.mapDefault.zoom)},ReportControl.prototype=new MappyComponent,ReportControl.prototype.initialize=function(t,e){ko.applyBindings(this,document.getElementById(this.options.el)),this.mappy=t,this.setupEvents(),e()},ReportControl.prototype.goToReport=function(){this.mappy.eventBus.openInNewWindow({url:this.options.generateReportBaseUrl})},ReportControl.prototype.setupEvents=function(){var t=this;this.renderedComponents=ko.observableArray([]),this.renderedComponents.subscribe(function(t){4===t.length&&window.ExpertPdfJSObj&&$(".completeRender").promise().done(function(){setTimeout(function(){window.ExpertPdfJSObj.startConversion()},3e3)})}),this.mappy.eventBus.layersLoading.subscribe(function(e){0===e.length&&t.renderedComponents.push("map layers")}),this.mappy.eventBus.reportChartsRendered.subscribe(function(e){3===e.length&&t.renderedComponents.push("charts")}),this.mappy.eventBus.gridsRendered.subscribe(function(e){1===e.length&&t.renderedComponents.push("grids")}),this.mappy.eventBus.layerLoaded.subscribe(function(){t.renderedComponents.push("layers")})},GeocoderControl.prototype=new MappyComponent,GeocoderControl.prototype.initialize=function(t,e){var o=new L.Control.OsmGeocoder({keepOpen:this.options.keepOpen,searchLabel:this.options.translations.searchLabel});window.map.addControl(o),e()},GeocoderControl.prototype.initialized=function(){},MapScaleControl.prototype=new MappyComponent,MapScaleControl.prototype.initialize=function(t,e){var o={position:"bottomright"};L.control.scale(o).addTo(window.map),e()},MapScaleControl.prototype.initialized=function(){},RiskRatingsPanel.prototype=new MappyComponent,RiskRatingsPanel.prototype.initialize=function(t,e){var o=this;o.mappy=t,this.service=t.layerServices.overlayGroups,o._subscribeToParsedLayerGroups(),o._setLabels(),o._initRiskRatingsPanel();var i=this.$el.find("#riskRatingsDropDown");i.select2().on("change",function(t){var e=_.find(o.options.riskRatingsPanelVm.availableOverlays(),{name:t.val});e&&(o.options.riskRatingsPanelVm.selectedOverlay(e),o.mappy.eventBus.riskRatingLayer(e.name))}).on("select2-opening",function(){$(".select2-search").hide()}),e()},RiskRatingsPanel.prototype.initialized=function(){},RiskRatingsPanel.prototype._subscribeToParsedLayerGroups=function(){var t=this;this.service.layers.parsedLayerGroups.subscribe(function(){t.overlayGroups(t.service.layers.parsedLayerGroups()),t._pushToRiskRatingsPanel(),t.mappy.mappyState.mapSetting&&""!==t.mappy.mappyState.mapSetting.selectedRiskRatingLayer?($("#"+t.options.el).find("#riskRatingsDropDown").select2("val",t.mappy.mappyState.mapSetting.selectedRiskRatingLayer),t.mappy.eventBus.riskRatingLayer(t.mappy.mappyState.mapSetting.selectedRiskRatingLayer)):t._setDefaultLayer()})},RiskRatingsPanel.prototype._pushToRiskRatingsPanel=function(){var t=this,e=t.options.riskRatingsPanelVm,o=[{name:this.options.translations.emptyOverlayOptionName,layerGroup:null}];if(_.forOwn(t.overlayGroups(),function(t){o.push({name:t.name,layerGroup:t._layers})}),e.availableOverlays(o),t.mappy.mappyState.mapSetting&&""!==t.mappy.mappyState.mapSetting.selectedRiskRatingLayer){var i=_.find(t.options.riskRatingsPanelVm.availableOverlays(),{name:t.mappy.mappyState.mapSetting.selectedRiskRatingLayer});void 0!==i&&t.options.riskRatingsPanelVm.selectedOverlay(i)}},RiskRatingsPanel.prototype._initRiskRatingsPanel=function(){var t=this,e=t.options.riskRatingsPanelVm,o=[{name:this.options.translations.emptyOverlayOptionName,layerGroup:null}];e.availableOverlays(o),e.selectedOverlay.subscribe(function(t){void 0!==t&&null!==t.layerGroup&&_.forOwn(t.layerGroup,function(t){window.map.removeLayer(t)})},this,"beforeChange"),e.selectedOverlay.subscribe(function(t){if(null!==t.layerGroup){var e=10;_.forOwn(t.layerGroup,function(t){t.setZIndex(e),e+=2,window.map.addLayer(t)})}}),ko.applyBindings(e,document.getElementById(t.options.el))},RiskRatingsPanel.prototype._setDefaultLayer=function(){var t=this,e=t.options.riskRatingsPanelVm;if(void 0!==t.service.options.defaultLayer&&e.selectedOverlay().name!==t.service.options.defaultLayer){var o=_.find(e.availableOverlays(),{name:t.service.options.defaultLayer});o&&e.selectedOverlay(o)}},RiskRatingsPanel.prototype._setLabels=function(){this.options.riskRatingsPanelVm.title=this.options.translations.title},BaseLayersPanel.prototype=new MappyComponent,BaseLayersPanel.prototype.initialize=function(t,e){this.service=t.layerServices.baseLayerGroups;var o=this.service.options.defaultLayer;t.mappyState.baseLayer&&(o=t.mappyState.baseLayer),this.defaultLayer(o),this.selectedLayer=this.defaultLayer(),ko.applyBindings(this,document.getElementById(this.options.el)),this._subscribeToParsedLayerGroups(),e()},BaseLayersPanel.prototype.initialized=function(){},BaseLayersPanel.prototype._setTranslations=function(){void 0===this.options.translations},BaseLayersPanel.prototype._subscribeToParsedLayerGroups=function(){var t=this;this.service.layers.parsedLayerGroups.subscribe(function(){t.baseLayerGroups(t.service.layers.parsedLayerGroups())})},BaseLayersPanel.prototype.click=function(t,e){this.removeBaseLayers(),this.selectedLayer=t.name,t.setZIndex(1),window.map.addLayer(t),$(document.getElementById(this.options.el)).find("li a").removeClass("active"),$(e.currentTarget).addClass("active")},BaseLayersPanel.prototype.removeBaseLayers=function(){var t=this;_.forOwn(t.baseLayerGroups(),function(t){window.map.removeLayer(t)})},NewsPanel.prototype=new MappyComponent,NewsPanel.prototype.initialize=function(t,e){var o=this;this.itemsVm=t.itemsVm,this.items=t.itemsVm.items,ko.applyBindings(this,document.getElementById(this.options.el)),o._initDynamicResizingOnWindowResize(),o._resizeDynamically(),o._disableMouseWheelMapZoomOnPanelHover(),e()},NewsPanel.prototype._disableMouseWheelMapZoomOnPanelHover=function(){this.$el.on("mouseover",function(){window.map.scrollWheelZoom.disable(),window.map.doubleClickZoom.disable(),window.map.dragging.disable()}),this.$el.on("mouseout",function(){window.map.scrollWheelZoom.enable(),window.map.doubleClickZoom.enable(),window.map.dragging.enable()})},NewsPanel.prototype._initDynamicResizingOnWindowResize=function(){var t=this;$(window).resize(function(){t._resizeDynamically()})},NewsPanel.prototype._resizeDynamically=function(){var t=$("#map").height();$(".newsPanelItems").height(t-this.options.margin.top-this.options.margin.bottom)},NewsPanel.prototype.displayItem=function(t,e){if(!$(e.currentTarget).hasClass("active")&&($(".newsPanelItemDetail").slideUp(),$(".newsPanelItem").removeClass("active"),$(e.currentTarget).addClass("active"),$(e.currentTarget).children(".newsPanelItemDetail").slideToggle(),void 0!==t.geometry&&!isZeroCoord(t.geometry))){var o=L.GeoJSON.coordsToLatLng(t.geometry.coordinates),i=t.group+"_"+t.properties.id,n=map.getMaxZoom()-3;map.setView(o,n);var a=function(){for(var t in map._layers){var e=map._layers[t];if(e.hasOwnProperty("_markers"))for(var o in e._markers)if(e._markers[o]._leaflet_id===i)return e}},s=50,r=0,p=100,l=function(t){r+=1,void 0!==t&&map.getZoom()===map.getMaxZoom()&&(r>=s||setTimeout(function(){t.hasOwnProperty("_group")||l(t),null===t._group._spiderfied&&(t.spiderfy(),l(t))},p))},d=a();if(void 0!==window._previousSpiderLayer){if(window._previousSpiderLayer===d)return;"function"==typeof window._previousSpiderLayer.unspiderfy&&window._previousSpiderLayer.unspiderfy()}window._previousSpiderLayer=d,l(d)}},NewsPanel.prototype.toggle=function(){var t=this.options.toggleSpeed;this.panelIsVisible?(this.panelIsVisible=!1,$("#newsPanel").animate({duration:t,right:-this.elInitialWidth})):(this.panelIsVisible=!0,$("#newsPanel").animate({duration:t,right:0})),fadeToggle({visible:this.panelIsVisible,fadeSpeed:t,panelId:".toggledNewsPanel",visibleStateId:".toggleNewsPanel2Arrow",hiddenStateId:".toggleNewsPanel2ArrowLeft"})},function(){function t(t){if(t.showOnMap){t.abortPendingAjaxRequest();var i=map.getZoom(),n=10;if(n>i)e(t);else{var a=map.getBounds(),s={top_left:{lat:a.getNorthWest().lat,lon:a.getNorthWest().lng},bottom_right:{lat:a.getSouthEast().lat,lon:a.getSouthEast().lng}};l(t);var r=t.runningLayerStateTracker;o(t,s,r)}}}function e(t){var e=map.getZoom(),o=f[e],i=map.getBounds(),n={factor:o,top_left:{lat:i.getNorthWest().wrap().lat,lon:i.getNorthWest().wrap().lng},bottom_right:{lat:i.getSouthEast().wrap().lat,lon:i.getSouthEast().wrap().lng}};3>=e&&(n={factor:o});var a=$.extend({},n,t.filterOptions),s=t.issueAjaxToken();t.pushAjaxRequest(s);var r=t.layer.clusterUrl,p=t.runningLayerStateTracker;$.ajax({dataType:"json",data:a,url:r,success:function(e){if(!t.showOnMap||p!==t.runningLayerStateTracker||!t.validAjaxRequest(s))return void t.removeAjaxRequest(s);try{u(t,e,p)}catch(o){throw o}finally{t.removeAjaxRequest(s)}},error:function(){t.removeAjaxRequest(s)}})}function o(t,e,o){var i=t.layer.markerUrl,n=$.extend({},e,t.filterOptions),a=t.issueAjaxToken();t.pushAjaxRequest(a),$.ajax({dataType:"json",type:"GET",data:n,url:i,success:function(e){if(!t.showOnMap||o!==t.runningLayerStateTracker||!t.validAjaxRequest(a))return void t.removeAjaxRequest(a);try{r(t,e)}catch(i){throw i}finally{t.removeAjaxRequest(a)}},error:function(){t.removeAjaxRequest(a)}})}function i(t){var e={iconUrl:"marker.png",shadowUrl:"I-shadow.png",iconSize:[47,40],shadowSize:[50,64],iconAnchor:[21,39],shadowAnchor:[6,55],popupAnchor:[-3,-76]};return e=_.defaults(t,e),new L.icon(e)}function n(t,e){return void 0===t.iconsDict[e]?null:(void 0===t.iconsDict[e].leafletIcon&&(t.iconsDict[e].leafletIcon=i({iconUrl:t.iconsDict[e].url,shadowUrl:t.iconsDict[e].shadowUrl,altIconUrl:t.iconsDict[e].altIconUrl})),t.iconsDict[e].leafletIcon)}function a(t,e){var o=[e.lat,e.lon],i={};if(e.markerIcon){var a=n(t,e.markerIcon);null!==a&&(i.icon=a)}var r=L.marker(o,i);return""+t.selectedMarkerId==""+e.id&&window.highlightMarker(r),r.on("click",function(){t.options.mappy.eventBus.markerOnMapClicked({markerVm:e,marker:r,layer:t.layer})}),r.on("click",function(o){t.options.mappy.options.lockDown||s(t,o.latlng,e.id)}),void 0===t.loaded&&t.options.mappy.mappyState.mapSetting&&e.id===t.options.mappy.mappyState.mapSetting.selectedMarker&&(t.loaded=!0,s(t,o,e.id)),r}function s(t,e,o){$.get(t.layer.markerInfoUrl+"?id="+o,function(i){var a,s=window.moment.utc(i.date),r=s.format("DD MMM YYYY"),p=n(t,i.markerIcon);null!==p&&(a=p.options.altIconUrl);var l=i.template||g;void 0!==t.options.layer.options.popupOptions&&void 0!==t.options.layer.options.popupOptions.popupTemplate&&(l=t.options.layer.options.popupOptions.popupTemplate),$("body").prepend('<div id="markerPopup">'+l+"</div>"),ko.applyBindings({layerColor:t.layer.options.colour,dateTimeString:r,altIconUrl:a,locationPrecisionText:(t.layer.options.locationPrecisionLabel||"Location Precision")+": ",data:i},document.getElementById("markerPopup"));var d=!0;t.options.mappy.options.lockDown&&(d=!1),L.popup({markerId:o,autoPanPaddingTopLeft:L.point(0,40),closeOnClick:d,markerLayer:t.layer}).setLatLng(e).setContent($("#markerPopup")[0]).openOn(map);var c=$(".leaflet-popup-content-wrapper"),u=c.height();c.css("border-bottom",u+"px solid #fff"),$(".leaflet-popup-content").css("margin-bottom","-"+u+"px")})}function r(t,e){var o=[];_.forEach(e,function(e){if(null!==e.lat&&void 0!==e.lat&&null!==e.lon&&void 0!==e.lon){var i=a(t,e);o.push(i)}}),void 0===t.markerClusterGroup&&(t.markerClusterGroup=new L.MarkerClusterGroup({iconCreateFunction:function(e){return p(t,e.getChildCount())},maxClusterRadius:50}),t.markerClusterGroup.addTo(map)),t.markerClusterGroup.addLayers(o)}function p(t,e){var o=" "+t.layer.options.slug+"-marker-cluster-";return o+=10>e?"small":100>e?"medium":"large",new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+o,iconSize:new L.Point(40,40)})}function l(t){d(t),c(t)}function d(t){t.clusterLayerGroup&&(map.removeLayer(t.clusterLayerGroup),t.clusterLayerGroup=void 0),t.clusterBoundsHoverLayerGroup&&(map.removeLayer(t.clusterBoundsHoverLayerGroup),t.clusterBoundsHoverLayerGroup=void 0)}function c(t){t.markerClusterGroup&&(map.removeLayer(t.markerClusterGroup),t.markerClusterGroup=void 0)}function u(t,e,i){c(t);var n=[];_.each(e,function(e){var a=[e.center.lat,e.center.lon];if(e.total>1){var s=[[e.top_left.lat,e.top_left.lon],[e.bottom_right.lat,e.bottom_right.lon]],r=L.marker(a,{icon:p(t,e.total)});r.cluster=e,r.boundsVisible=!1,r.bounds=s;var l=L.rectangle(s,{color:"#ff7800",weight:1});r.rectangleBounds=l,r.on("mouseover",function(e){t.clusterBoundsHoverLayerGroup=L.layerGroup().addTo(map),t.clusterBoundsHoverLayerGroup.addLayer(e.target.rectangleBounds)}),r.on("mouseout",function(){map.removeLayer(t.clusterBoundsHoverLayerGroup),t.clusterBoundsHoverLayerGroup=void 0}),r.on("click",function(){t.options.mappy.eventBus.serverClusterOnMapClicked({rectangleBounds:l})}),n.push(r)}else{var d={top_left:{lat:e.center.lat,lon:e.center.lon},bottom_right:{lat:e.center.lat,lon:e.center.lon}};o(t,d,i)}}),d(t);var a=L.layerGroup(n,{zoomAnimation:!0,animate:!0});a.addTo(map),t.clusterLayerGroup=a}function h(t){t.iconsDict={},t.layer.options.markerIcons&&_.forEach(t.layer.options.markerIcons,function(e){t.iconsDict[e.name]={url:e.iconUrl,shadowUrl:e.shadowUrl,altIconUrl:e.altIconUrl}})}function m(e){var o=e.options.mappy.eventBus;o.mapManipulated.subscribe(function(){window.clearHighlightMarker(),t(e)}),o.markerOnMapClicked.subscribe(function(t){t.selectRow!==!0&&(e.selectedMarkerId=t.markerVm.id,highlightMarker(t.marker))}),o.serverClusterOnMapClicked.subscribe(function(t){e.options.mappy.options.lockDown||map.fitBounds(t.rectangleBounds,{animate:!0})}),e.runningLayerStateTracker=0,o.layerFiltersChanged.subscribe(function(o){e.layer.options.slug===o.layer.options.slug&&(e.runningLayerStateTracker++,e.showOnMap=o.showOnMap,e.filterOptions=o.filterOptions,o.showOnMap?t(e):(e.selectedMarkerId=-1,l(e)))}),o.triggerZoomToMarker.subscribe(function(t){if(t.bindTo!==e.layer.options.slug)return void(e.selectedMarkerId=-1);if(void 0!==t.geoJsonCoordinates&&null!==t.geoJsonCoordinates){var o=e.selectedMarkerId;e.selectedMarkerId=t.id;var i=L.GeoJSON.coordsToLatLng(t.geoJsonCoordinates),n=9,a=e.layer.options.focusZoomLevel;if(void 0!==a&&a<=window.map.getMaxZoom()&&a>0&&(n=a),map.setView(i,n),o!==e.selectedMarkerId){if(e.options.mappy.options.lockDown)return;s(e,i,t.id)}else e.selectedMarkerId=-1}else e.selectedMarkerId=-1,(void 0===t.geoJsonCoordinates||null===t.geoJsonCoordinates)&&window.map.setView([e.options.mappy.options.mapDefault.centerLat,e.options.mappy.options.mapDefault.centerLng],e.options.mappy.options.mapDefault.zoom)})}function y(t){t.ajaxToken=0,t.issueAjaxToken=function(){return t.ajaxToken++,t.ajaxToken},t.pushAjaxRequest=function(e){t.ajaxRequests.push(e)},t.removeAjaxRequest=function(e){t.ajaxRequests.remove(e)},t.validAjaxRequest=function(e){return t.ajaxRequests.indexOf(e)>=0},t.abortPendingAjaxRequest=function(){t.ajaxRequests.removeAll()},t.ajaxRequests.subscribe(function(){0===t.ajaxRequests().length?t.options.mappy.eventBus.finishLayerLoad(t.layer):t.options.mappy.eventBus.startLayerLoad(t.layer)}),window.mappy=t.options.mappy}var f={};f[1]=.9,f[2]=.9,f[3]=.88,f[4]=.86,f[5]=.85,f[6]=.82,f[7]=.79,f[8]=.75,f[9]=.7,f[10]=.7,f[11]=.7,f[12]=.7,f[13]=.7,f[14]=.7;var g='<div data-bind="style: { color: layerColor }"><h4 data-bind="text: data.country"></h4><h5 data-bind="text: dateTimeString"></h5><hr data-bind="style: { backgroundColor: layerColor }" /><p><span data-bind="text: data.categoryText"></span><span>: </span><span data-bind="text: data.type"></span><img data-bind="attr: { src: altIconUrl }, visible: altIconUrl !== undefined" class="markerPopupIcon"></p> <p><span data-bind="text: locationPrecisionText"></span><span data-bind="text: data.LocationPrecision"></span></p><hr data-bind="style: { backgroundColor: layerColor }"/><p data-bind="text: data.description"></p></div>';L.Items2LayerGroup=L.LayerGroup.extend({initialize:function(t){var e=this;e.ajaxRequests=ko.observableArray(),e.options=t,e.layer=t.layer,e._leaflet_id=e.layer.options.slug,h(e),y(e),m(e)}}),L.items2LayerGroup=function(t){return new L.Items2LayerGroup(t)}}(),Mappy.prototype._initMap=function(t,e,o){this.optionsVm=new OptionsVm({dateFrom:this.options.initialDateFrom,dateTo:this.options.initialDateTo});var i=getParameterByName("country");null!==i&&this.optionsVm.country(i);var n=this,a=new L.LatLngBounds(new L.LatLng(90,-180),new L.LatLng(-90,180)),s={zoomControl:!1,zoomAnimation:!0,fadeAnimation:n.options.mapDefault.fadeAnimation,attributionControl:!1,minZoom:n.options.mapDefault.minZoom,maxZoom:n.options.mapDefault.maxZoom,center:new L.LatLng(t,e),zoom:o,worldCopyJump:!0,trackResize:!0,maxBounds:a};window.map=L.map(n.options.mapEl,s),n.map=window.map,window.map.whenReady(function(){n.options.lockDown&&(n.map.dragging.disable(),n.map.touchZoom.disable(),n.map.doubleClickZoom.disable(),n.map.scrollWheelZoom.disable());var t=function(){var t=window.map.getBounds(),e={zoom:window.map.getZoom(),bounds:{topLeft:{lat:t._northEast.lat,lon:t._southWest.lng},bottomRight:{lat:t._southWest.lat,lon:t._northEast.lng}}};return e};window.map.on("zoomend",function(){var e=t();n.eventBus.mapManipulated(e),n.eventBus.zoomend(e)}),window.map.on("dragend",function(){var e=t();n.eventBus.mapManipulated(e),n.eventBus.dragend(e)}),window.map.on("viewreset",function(){var e=t();n.eventBus.mapManipulated(e)}),window.map.on("resize",function(){var e=t();n.eventBus.mapManipulated(e),n.eventBus.mapResize(e)}),window.map.on("popupopen",function(t){n.eventBus.openedMarker(t.popup.options.markerId),n.eventBus.openedMarkerSlug(t.popup.options.markerLayer.options.slug)}),window.map.on("popupclose",function(){n.eventBus.openedMarker(-1)}),n.eventBus.openInNewWindow.subscribe(function(t){var e=t.url;void 0!==t.url&&n.exportViewToQueryString(function(t){e+=e.indexOf("?")>-1?"&mappyCompressed="+t:"?mappyCompressed="+t,window.open(e)})}),void 0!==n.options.whenMapIsReady&&n.options.whenMapIsReady()}),this.$mapEl=$("#"+this.options.mapEl),this.$el=$("#"+this.options.el),n._defineMapDefaultViewDefaultMapBounds(),n._calculateBrowserScrollWidth(),n._setLanguage(),n._invalidateSizeOnContainerResize(),n._initLayerServices(),n._initComponents()},Mappy.prototype._initComponents=function(){_.each(this.components,function(t){t.initialize(this,function(){_.has(t,"initialized")&&t.initialized()})},this)},Mappy.prototype._initLayerServices=function(){var t=this;_.forIn(this.options.layerServices,function(e,o){var i=t.options.layerOptions[o];e.mappy=t,e.initialize(t,i,function(){void 0!==e.initialized&&e.initialized()})})},Mappy.prototype._invalidateSizeOnContainerResize=function(){$("#mappy").resize(function(){window.map})},Mappy.prototype._defineMapDefaultViewDefaultMapBounds=function(){_.isUndefined(this.options.mapBounds.defaultMapBounds)||(map.fitBounds(this.options.mapBounds.defaultMapBounds),!_.isUndefined(this.options.mapBounds.fixDefaultMapBounds)&&this.options.mapBounds.fixDefaultMapBounds&&map.setMaxBounds(this.options.mapBounds.defaultMapBounds),this.options.mapDefault.zoom=map.getZoom(),this.options.mapDefault.centerLat=map.getCenter().lat,this.options.mapDefault.centerLng=map.getCenter().lng,map.setView(new L.LatLng(this.options.mapDefault.centerLat,this.options.mapDefault.centerLng),this.options.mapDefault.zoom))},Mappy.prototype._setMiniMap=function(){},Mappy.prototype._setUrlHash=function(){},Mappy.prototype._setLanguage=function(){var t=this.toDatePickLanguage();$.datepick.setDefaults($.datepick.regional[t]),void 0===this.options.language?window.moment.lang("en"):window.moment.lang(this.options.language)},Mappy.prototype.toDatePickLanguage=function(){var t=this.options.language;return"en"===t?t="":"en-GB"===t?t="":"es"===t?t="es":"zh-CN"===t?t="zh-CN":"fr-FR"===t?t="fr":"ja-JP"===t?t="ja":"ko-KR"===t?t="ko":"pt-PT"===t&&(t="pt"),t},Mappy.prototype.viewableHeight=function(){return this.$mapEl.height()-$("#dateSliderPanel").outerHeight()-$("#mapHeader").outerHeight()},Mappy.prototype._calculateBrowserScrollWidth=function(){var t=$('<div class="scrollbar-measure"></div>');this.$mapEl.prepend(t),t.css({width:100,height:100,overflow:"scroll",position:"absolute",top:-9999});var e=t[0].offsetWidth-t[0].clientWidth;this.browserScrollBarWidth=e,t.remove()},Mappy.prototype._addSpinner=function(){var t=$('<div id="spinner" data-bind="visible: hasItemsLoading"></div>');this.$mapEl.append(t);var e={lines:13,length:20,width:10,radius:30,color:this.options.spinnerColor};window.addSpinner(e,t)},Mappy.prototype.isIE=function(){var t=navigator.userAgent.toLowerCase();return-1!==t.indexOf("msie")?parseInt(t.split("msie")[1]):!1},Mappy.prototype.exportViewToQueryString=function(t){var e=moment(this.optionsVm.dateFrom()).toISOString(),o=moment(this.optionsVm.dateTo()).toISOString(),i={dateFrom:e,dateTo:o},n=this.optionsVm.itemFilterGroups(),a={};_.forEach(n,function(t){var e={};e.showOnMap=t.object.showOnMap();var o=t.object.selectedFilterOptions();o&&(e.selectedOptions=t.object.selectedFilterOptions()),a[t.id]=e});var s;this.components.baseLayersPanel&&(s=this.components.baseLayersPanel.selectedLayer);var r={};_.forIn(this.components,function(t){"GridControl2"===t.type&&(r[t.options.bindTo]={settings:t.exportGridSettings()})});var p={zoom:this.map.getZoom(),centerLat:this.map.getCenter().lat,centerLng:this.map.getCenter().lng,selectedMarker:this.eventBus.openedMarker(),selectedMarkerSlug:this.eventBus.openedMarkerSlug(),selectedRiskRatingLayer:this.eventBus.riskRatingLayer()},l=window.JSON.stringify({dateFilterSetting:i,itemFilterSetting:a,baseLayer:s,gridSettings:r,mapSetting:p,clientTimezone:(new Date).getTimezoneOffset()/60*-1});LZMA.compress(l,1,function(e){var o=window.convertToFormattedHex(e);o=o.replace(/ /g,""),_.isFunction(t)&&t(o)})};var hm;ko.bindingHandlers.dateString={update:function(t,e,o,i){var n=e(),a=o(),s=ko.utils.unwrapObservable(n),r=a.datePattern||"MM/DD/YYYY";$(t).val(moment(s).format(r))}},RightPanel.prototype=new MappyComponent,RightPanel.prototype.initialize=function(t,e){var o=this;o.mappy=t,this.setDefaults(o.options.el),o._addPanelActions(),this.$el.css("max-height",t.viewableHeight()),t.$mapEl.resize(function(){$("#"+o.options.el).css("max-height",t.viewableHeight())}),o.$el.resize(_.debounce(function(){o._padScrollBar()},50)),this.scrollPadded=!1,this.titleText=this.options.translations.title,this.reportTitle=this.options.translations.reportTitle,ko.applyBindings(this,document.getElementById(o.options.el)),o._setupEvents(),this._disableMouseWheelMapZoomOnPanelHover(),e()},RightPanel.prototype._padScrollBar=function(){if(1!==this.openState())return this.$el.css("width",""),void(this.scrollPadded=!1);var t=this.$el[0].offsetWidth-this.$el[0].clientWidth;t>0?this.scrollPadded||(9===this.mappy.isIE()?this.$el.width(this.$el[0].offsetWidth+this.mappy.browserScrollBarWidth+30):this.$el.width(this.$el[0].offsetWidth+this.mappy.browserScrollBarWidth),this.scrollPadded=!0):this.scrollPadded&&(this.$el.css("width",""),this.scrollPadded=!1)},RightPanel.prototype.addPanelSection=function(t){var e=function(t){t.title&&(decorateWithToggleOpenBehaviour(this),t.accordionGroup&&decorateWithAccordionBehaviour(this,t.accordionGroup)),this.needsWrapper=ko.observable(!!t.title),this.targetElementId=t.targetElementId};this.panelSections.push(new e(t))},RightPanel.prototype._setupEvents=function(){var t=this;t.mappy.eventBus.markerOnMapClicked.subscribe(function(){this.openState()<1&&t.openState(1)}.bind(this)),t.mappy.eventBus.displayOnGridClicked.subscribe(function(){for(;t.openState()<2;)t.openState(t.openState()+1)})},RightPanel.prototype._addPanelActions=function(){var t=this;this.expand=function(){t.openState()<2&&t.openState(t.openState()+1)},this.contract=function(){t.openState()>0&&t.openState(t.openState()-1)},this.fastExpand=function(){for(;t.openState()<2;)t.openState(t.openState()+1)},this.fastContract=function(){t.openState()>0&&t.openState(0)},this.showLatestNews=function(){1!==t.openState()&&t.openState(1)},this.openToLatestNews=function(){0===t.openState()&&t.openState(1)}},GridControl2.prototype=new MappyComponent,GridControl2.prototype.initialize=function(t,e){if(this.mappy=t,t.mappyState&&t.mappyState.gridSettings&&t.mappyState.gridSettings[this.options.bindTo]){var o=t.mappyState.gridSettings[this.options.bindTo].settings;this.options.defaultSort.sortBy=o.sortBy,this.options.defaultSort.sortDirection=o.sortDirection}void 0!==t.options.layerServices.itemLayerGroups&&(this.service=t.options.layerServices.itemLayerGroups,this._initViewModel(),this.scrollPadded=!1,e())},GridControl2.prototype.loadData=function(t,e){var o=this;o.latestPageIndex=t;var i=this.viewModel.gridViewModel,n=t,a={},s=i.pageSize*t;a.from=s,a.size=i.pageSize;var r=i.sortOptions().slug,p="sortAscending"===i.sortOptions().direction?"asc":"desc";""!==r?a.sort=r+":"+p:a.sort=o.options.defaultSort.sortBy+":"+o.options.defaultSort.sortDirection;var l=$.extend({},o.filterOptions,a),d=o.viewModel.baseDataUrl;$.ajax({dataType:"json",url:d,data:l,success:function(a){if(!o.showOnMap)return void i.clearData();if(!o.latestPageIndex||o.latestPageIndex===n){i.dataCount(a.Total);var s=Math.ceil(i.dataCount()/i.pageSize)-1;i.maxPageIndex(s);var r=[];_.each(a.Payload,function(t){i.onRowLoaded&&i.onRowLoaded(t),i.pluckRowData?r.push(i.pluckRowData(t)):r.push(t)}),i.currentPageIndex(t),i.itemsOnCurrentPage(r),e&&e(),o.mappy.eventBus.gridsRendered.push(o.options.bindTo)}},error:function(t,e,o){}})},GridControl2.prototype.exportGridSettings=function(){var t=this,e={bindTo:t.options.bindTo},o=t.viewModel.gridViewModel,i=o.sortOptions().slug,n="sortAscending"===o.sortOptions().direction?"asc":"desc";return""!==i?(e.sortBy=i,e.sortDirection=n):(e.sortBy=t.options.defaultSort.sortBy,e.sortDirection=t.options.defaultSort.sortDirection),e},GridControl2.prototype._initViewModel=function(){var t=this;t.service.layers.metaData.subscribe(function(e){var o=_.where(e,function(e){return e.layers[0].options.slug===t.options.bindTo})[0].layers[0];t.viewModel={},t.viewModel.baseDataUrl=t.options.dataUrl,t.viewModel.colour=o.options.colour,t.viewModel.highlightColour=o.options.highlightColour,t.viewModel.gridViewModel=new ko.easyGrid2.viewModel({id:t.options.el,data:ko.observableArray([0]),columns:ko.observableArray(o.options.gridOptions.gridColumns),pageSize:t.options.pageSize,pageRange:o.options.gridOptions.gridPageRange,onRowLoaded:function(t){window.decorateWithToggleOpenBehaviour(t.properties),window.decorateWithAccordionBehaviour(t.properties,"datarow")},pluckRowData:function(t){return t.geometry&&(t.properties.geoJsonCoordinates=t.geometry.coordinates),t.properties}}),t.viewModel.gridViewModel.pageSelected=function(e){t.loadData(e)},t.viewModel.gridViewModel.sortOptions.subscribe(function(e){e.clearingData||t.loadData(t.viewModel.gridViewModel.currentPageIndex())}),t.viewModel.gridViewModel.displayItemOnMap=ko.computed({read:function(){return t.options.bindTo},write:function(e){t.mappy.eventBus.triggerZoomToMarker({bindTo:t.options.bindTo,id:e.id,geoJsonCoordinates:e.geoJsonCoordinates})},owner:this}),t.viewModel.gridViewModel.colour=o.options.colour,t.viewModel.gridViewModel.highlightColour=o.options.highlightColour,t.viewModel.gridViewModel.showSpinner=ko.computed(function(){var e=_.find(t.mappy.eventBus.layersLoading(),function(e){return e.options.slug===t.options.bindTo});return e}),t.viewModel.gridViewModel.gridDetailColumns=ko.observableArray(o.options.gridOptions.gridDetailColumns),t.viewModel.gridViewModel.gridSummaryColumns=ko.observableArray(o.options.gridOptions.gridSummaryColumns),window.decorateWithToggleOpenBehaviour(t.viewModel.gridViewModel),window.decorateWithAccordionBehaviour(t.viewModel.gridViewModel,"rightPanel");var i=$("#"+t.options.el),n=$($("#gridBindingTemplate2").html()).appendTo(i[0]);ko.applyBindings(t.viewModel,n[0]),t._addSpinner(o.options),t._setupEvents()})},GridControl2.prototype._setupEvents=function(){var t=this;t.mappy.eventBus.displayOnGridClicked.subscribe(function(e){t.options.bindTo===e&&(t.viewModel.gridViewModel.open()||t.viewModel.gridViewModel.toggleOpen())}),t.mappy.eventBus.layerFiltersChanged.subscribe(function(e){this.options.bindTo===e.layer.options.slug&&(t.showOnMap=e.showOnMap,t.filterOptions=e.filterOptions,e.showOnMap?this.loadData(0):this.viewModel.gridViewModel.clearData())},this),t.mappy.eventBus.markerOnMapClicked.subscribe(function(e){if(t.options.bindTo===e.layer.options.slug){var o=t.viewModel.gridViewModel;t.lastSelectedMapItem=e.markerVm.id;var i={};i.size=o.pageSize;var n=o.sortOptions().slug,a="sortAscending"===o.sortOptions().direction?"asc":"desc";""!==n?i.sort=n+":"+a:i.sort=t.options.defaultSort.sortBy+":"+t.options.defaultSort.sortDirection;var s=$.extend({},t.filterOptions,i);s.id=e.markerVm.id;var r=t.options.pageUrl;$.ajax({dataType:"json",url:r,data:s,success:function(o){t.lastSelectedMapItem&&t.lastSelectedMapItem!==e.markerVm.id||t.loadData(o,function(){t.viewModel.gridViewModel.open()||t.viewModel.gridViewModel.toggleOpen(),_.forEach(t.viewModel.gridViewModel.itemsOnCurrentPage(),function(o){""+o.id==""+e.markerVm.id&&(t.mappy.mappyState.mapSetting&&"undefined"!==t.mappy.mappyState.mapSetting.selectedMarkerSlug&&e.selectRow===!0&&t.mappy.eventBus.triggerZoomToMarker({bindTo:t.mappy.mappyState.mapSetting.selectedMarkerSlug,id:t.mappy.mappyState.mapSetting.selectedMarker,geoJsonCoordinates:o.geoJsonCoordinates
}),o.toggleOpen())})})}})}}),t.mappy.mappyState.mapSetting&&"undefined"!==t.mappy.mappyState.mapSetting.selectedMarkerSlug&&t.mappy.eventBus.markerOnMapClicked({selectRow:!0,layer:{options:{slug:t.mappy.mappyState.mapSetting.selectedMarkerSlug}},markerVm:{id:t.mappy.mappyState.mapSetting.selectedMarker}})},GridControl2.prototype._padScrollBar=function(){if(1!==this.openState())return this.$el.css("width",""),void(this.scrollPadded=!1);var t=this.$el[0].offsetWidth-this.$el[0].clientWidth;t>0?this.scrollPadded||(this.$el.width(this.$el[0].offsetWidth+this.mappy.browserScrollBarWidth),this.scrollPadded=!0):this.scrollPadded&&(this.$el.css("width",""),this.scrollPadded=!1)},GridControl2.prototype.initialized=function(){},GridControl2.prototype._addSpinner=function(t){var e=$("#"+this.options.el).find(".spinnerTarget"),o={color:t.colour};window.addSpinner(o,e)},GridControl2.prototype.viewModel=function(){},ChartsControl.prototype=new MappyComponent,ChartsControl.prototype.initialize=function(t,e){var o=this;this.mappy=t,this.lastBlownUpChart="",this._initializeChartDivs(),this._addCharts(),this._setupEvents(),this._subscribeToChartData(),ko.applyBindings(this,document.getElementById(this.options.el)),t.$mapEl.resize(_.debounce(function(){2===o.openState()&&o.blowUpChart(o.lastBlownUpChart)},500)),this._disableMouseWheelMapZoomOnPanelHover(),e()},ChartsControl.prototype._initializeChartDivs=function(){return this._chartRootDiv=$("#"+this.options.el),this._chartRootDiv.attr("data-bind",'css: "openState" + openState()'),Modernizr.inlinesvg?(this._chartToggle=$('<div id="chartToggleContainer" class="row"><div class="col-md-6 col-md-offset-3"><div id="toggle" data-bind="css: \'openState\' + openState()" ><div class="toggleButtons"><a class="up" data-bind="click: toggleOpen, visible: openState() < 2" href="#"></a></div><span>'+this.options.translations.analytics+'</span><div class="toggleButtons"><a class="down" data-bind="click: toggleAnalytics, visible: openState() > 0" href="#"></a></div></div></div></div>').prependTo(this._chartRootDiv),this._chartsContainer=$('<div id="chartsContainer"></div>').appendTo(this._chartRootDiv),this._blowUp=$('<div class="row maximized"></div>').appendTo(this._chartsContainer),void(this._chartContent=$('<div class="row thumbnails"></div>').appendTo(this._chartsContainer))):void this._chartRootDiv.append('<div id="chartToggleContainer"><div id="toggle" class="openState0"><span>Your browser does not support analytics</span></div></div>')},ChartsControl.prototype.toggleOpen=function(){if(0===this.openState())this.toggleAnalytics();else if(1===this.openState()){var t=this.lastBlownUpChart;""===t&&(t=this.options.charts[0]),this.blowUpChart(t)}},ChartsControl.prototype.toggleAnalytics=function(){0===this.openState()?this.openState(this.openState()+1):(this.openState(this.openState()-1),this.blownUpChart(null),this.setBlownUpClass()),this.openState()<0&&this.openState(0)},ChartsControl.prototype.blowUpChart=function(t){void 0===this.originalThumbnailsHeight&&(this.originalThumbnailsHeight=$(".thumbnails").outerHeight()),this._blowUp.height(this.mappy.viewableHeight()-this.originalThumbnailsHeight-80);var e="totalIncidentsByCategory"===t?100:180;this.openState(2),this.setBlownUpClass(t),this._blowUp.empty();var o=this.mappy.components[t];this.blownUpChart(o),this.lastBlownUpChart=t;var i="";""!==this.options.translations.disclaimerLinkUri&&""!==this.options.translations.disclaimerLinkText&&(i='<a href="'+this.options.translations.disclaimerLinkUri+'" class="pull-right disclaimer" target="_blank">'+this.options.translations.disclaimerLinkText+"</a>");var n=$('<div class="col-md-12 chartContainer '+t+'"><div class="chart-title">'+o.options.translations.title+i+'</div><div id="stackToolTip"></div><div class="chartWrapper"><div id="blowUpChartContent"></div></div></div>');n.find("#blowUpChartContent").height(this._blowUp.height()-26),this._blowUp.append(n);var a=o.create("#blowUpChartContent",{legend:!0,label:!0,rightmargin:e});a.render(),o.options.legendHeightRatio&&this._blowUp.find(".contour-legend").css({"overflow-y":"auto","max-height":"100%"})},ChartsControl.prototype.setBlownUpClass=function(t){_.each(this.options.charts,function(t){this._chartDivs[t].removeClass("blown-up")},this),t&&this._chartDivs[t].addClass("blown-up")},ChartsControl.prototype._setupEvents=function(){var t=this;t.ajaxTracker=0,this.mappy.eventBus.layerFiltersChanged.subscribe(function(e){_.forEach(t.options.charts,function(o){var i=this.mappy.components[o];if(i.options.bindTo===e.layer.options.slug)if(t.ajaxTracker++,e.showOnMap)i.refresh(e.filterOptions);else for(i.clear();t.openState()>0;)t.toggleAnalytics()},t)})},ChartsControl.prototype._subscribeToChartData=function(){var t=this;_.forEach(t.options.charts,function(e){var o=t.mappy.components[e];o.chartData.subscribe(function(t){void 0===t||t.length<=0||this.blownUpChart()&&this.blownUpChart().options.slug===o.options.slug&&this.blowUpChart(o.options.slug)},t)},t)},ChartsControl.prototype._addCharts=function(){_.forEach(this.options.charts,function(t){var e=this.mappy.components[t].addChartIcon();e.attr("data-bind",'click: function () { blowUpChart("'+t+'") }'),this._chartDivs[t]=e,this._chartContent.append(e)},this)},ReportChartsControl.prototype=new MappyComponent,ReportChartsControl.prototype.initialize=function(t,e){var o=this;this.mappy=t,this._setupEvents(),this._subscribeToChartData(),ko.applyBindings(this,document.getElementById(this.options.el)),this._chartRootDiv=$("#"+this.options.el).append("<h3>"+this.options.translations.titleText+"</h3>"),t.$mapEl.resize(_.debounce(function(){var t=$("#"+o.options.el);t.empty(),_.forEach(o.options.charts,function(t){var e=o.mappy.components[t];o.displayChart(e.options.slug)},this)},500)),e()},ReportChartsControl.prototype.displayChart=function(t){if(!$(".chartContainer"+t).length){var e=this.mappy.components[t],o=$("#"+this.options.el),i=t+"Chart",n=$('<div id="chartsContainer"><div class="col-md-12 chartContainer'+t+'"><div class="chart-title">'+e.options.translations.title+'</div><div id="stackToolTip"></div><div class="chartWrapper"><div id="'+i+'"></div></div></div></div>').appendTo(o),a=e.options.height?e.options.height:this.options.height;$("#"+i).height(a),this.blownUpChart(e);var s=e.create("#"+i,{legend:!0,label:!0,rightmargin:e.options.marginRight});s.render(),e.options.legendHeightRatio&&n.find(".contour-legend").css({"overflow-y":"auto","max-height":$("#"+i).height()*e.options.legendHeightRatio}),e.options.marginLeft&&n.find("svg").css({"margin-left":e.options.marginLeft}),$(".contour-legend-key").each(function(){$(this).css("border-color",$(this).css("background-color"))})}},ReportChartsControl.prototype._setupEvents=function(){var t=this;t.ajaxTracker=0,this.mappy.eventBus.layerFiltersChanged.subscribe(function(e){_.forEach(t.options.charts,function(o){var i=this.mappy.components[o];if(i.options.bindTo===e.layer.options.slug)if(t.ajaxTracker++,e.showOnMap)i.refresh(e.filterOptions);else for(i.clear();t.openState()>0;);},t)})},ReportChartsControl.prototype._subscribeToChartData=function(){var t=this;_.forEach(t.options.charts,function(e){var o=t.mappy.components[e];o.chartData.subscribe(function(t){void 0===t||t.length<=0||(this.displayChart(o.options.slug),this.mappy.eventBus.reportChartsRendered.push(o.options.slug))},t)},t)},RiskRatingsLegends.prototype=new MappyComponent,RiskRatingsLegends.prototype.initialize=function(t,e){this.service=t.layerServices.riskRatingsLegends,ko.applyBindings(this,document.getElementById(this.options.el)),this._subscribeToParsedLegends(),e()},RiskRatingsLegends.prototype.initialized=function(){},RiskRatingsLegends.prototype._subscribeToParsedLegends=function(){var t=this;this.service.parsedLegends.subscribe(function(){t.riskRatingsLegends(t.service.parsedLegends())})},ReportLegends.prototype=new MappyComponent,ReportLegends.prototype.initialize=function(t,e){this.translations=this.options.translations,this.hasAssets=!1,t.mappyState.itemFilterSetting.assets&&(this.hasAssets=t.mappyState.itemFilterSetting.assets.showOnMap),ko.applyBindings(this,document.getElementById(this.options.el)),e()},ReportLegends.prototype.initialized=function(){},MappyChartComponent.prototype=new MappyComponent,MappyChartComponent.prototype._getData=function(t,e){var o=this;o._removeAll();var i=o.ajaxTracker;$.ajax({dataType:"json",data:ko.toJS($.param(e)),url:t,success:function(t){o.ajaxTracker===i&&$.each(t,function(t,e){o.chartDataDictionary.push({id:t,object:e})})},error:function(t,e,o){}})},MappyChartComponent.prototype._removeAll=function(){void 0!==this.chartDataDictionary&&this.chartDataDictionary.removeAll(),void 0!==this.chartData&&this.chartData.removeAll()},MappyChartComponent.prototype.clear=function(){this._removeAll()},MappyChartComponent.prototype.refresh=function(t){var e=$.extend({},t,this.options.parameters);this._getData(this.options.dataUrl,e)},MappyChartComponent.prototype.subscribe=function(){this.chartDataDictionary.subscribe(function(t){this.process(t)}.bind(this),null,"arrayChange")},MappyChartComponent.prototype.addChartIcon=function(){return this.chartContent=$('<div class="col-sm-4 iconContainer"><div><h6>'+this.options.translations.shortTitle+'</h6><div class="'+this.options.type+'"><div id="'+this.options.slug+'"></div></div></div></div>'),this.chartContent},MappyChartComponent.prototype.getAggName=function(t){return"by_{0}".replace("{0}",t.toLowerCase().replace(" ",""))},ChartDateHistogramIncidentsByField.prototype=new MappyChartComponent,ChartDateHistogramIncidentsByField.prototype.initialize=function(t,e){this.mappy=t,this.subscribe(),e()},ChartDateHistogramIncidentsByField.prototype.create=function(t,e){var o=this,i={legend:!1,label:null,rightmargin:0};e=_.defaults(e,i);var n=_.cloneDeep(this.chartData()[0]),a=this.mappy.toDatePickLanguage(),s=new Contour({el:t,chart:{margin:{right:e.rightmargin},defaultAspect:.5,animations:o.options.animations},xAxis:{maxTicks:15,labels:{format:"%b",rotation:this.options.rotation},linearDomain:!0,tickPadding:this.options.tickPadding},yAxis:{labels:{format:"d"}},legend:{vAlign:"top",hAlign:"right",direction:"vertical"},tooltip:{formatter:function(t){var e=new Date(t.meta.Date),o=$.datepick.regional[a].monthNamesShort[e.getUTCMonth()]+" "+e.getUTCFullYear();return o+" ("+t.y+")"}}}).cartesian().line(n).tooltip();return e&&e.legend&&s.legend(n),s},ChartDateHistogramIncidentsByField.prototype.process=function(t){if(!(void 0===t||t.length<=0)&&t[0].value.id===this.getAggName(this.options.parameters.field)&&"added"===t[0].status){var e=[];_.each(t[0].value.object.Items,function(t){var o=[];_.each(t.Aggregations[this.getAggName(this.options.parameters.interval)].Items,function(t){o.push({meta:t,x:t.KeyAsString,y:t.DocCount})},this);var i=_.contains(this.options.parameters.excludeFields,t.Key);i||e.push({name:t.Key,data:o})},this),e=_.sortBy(e,function(t){var e=_.min(t.data,function(t){return new Date(t.meta.Date)});return new Date(e.meta.Date)}),this.chartData.push(e)}},ChartIncidentsByField.prototype=new MappyChartComponent,ChartIncidentsByField.prototype.initialize=function(t,e){this.subscribe(),e()},ChartIncidentsByField.prototype.create=function(t,e){var o=this,i=_.cloneDeep(this.chartData()[0]),n=new Contour({el:t,chart:{defaultAspect:.5,margin:{right:e.rightmargin},animations:o.options.animations},pie:{innerRadius:15,piePadding:2},tooltip:{formatter:function(t){return t.data.x+" ("+t.value+")"},distance:140},legend:{vAlign:"top",hAlign:"right",direction:"vertical"}}).pie(i).tooltip();return e&&e.legend&&n.legend(_.map(_.pluck(i,"x"),function(t){return{name:t,data:[]}})),n},ChartIncidentsByField.prototype.process=function(t){if(!(void 0===t||t.length<=0)&&t[0].value.id===this.getAggName(this.options.parameters.field)&&"added"===t[0].status){var e=[];t[0].value.object.Items=_.sortBy(t[0].value.object.Items,function(t){return-1*t.DocCount}),_.each(_.first(t[0].value.object.Items,this.options.showTop),function(t){e.push({x:t.Key+(this.options.isForReport?" ("+t.DocCount+")":""),y:t.DocCount})},this);var o=_.size(t[0].value.object.Items);if(o>this.options.showTop){var i=_.reduce(_.last(t[0].value.object.Items,o-this.options.showTop),function(t,e){return t+e.DocCount},0);e.push({x:this.options.translations.others+(this.options.isForReport?" ("+i+")":""),y:i})}this.chartData.push(e)}},ChartIncidentsByFieldByField.prototype=new MappyChartComponent,ChartIncidentsByFieldByField.prototype.initialize=function(t,e){this.subscribe(),e()},ChartIncidentsByFieldByField.prototype.create=function(t,e){var o=this,i={legend:!1,label:null,rightmargin:0};e=_.defaults(e,i);var n,a=_.cloneDeep(this.chartData()[0]);e&&e.label&&(n={categories:_.uniq(_.flatten(_.map(_.pluck(a,"data"),function(t){return _.pluck(t,"x")}))),labels:{rotation:this.options.rotation},tickPadding:this.options.tickPadding});var s,r=Math.max.apply(Math,this.chartData()[0].map(function(t){return t.total}));s=10>r?{ticks:r}:{};var p=new Contour({el:t,chart:{margin:{right:e.rightmargin},defaultAspect:.5,animations:o.options.animations},xAxis:n,yAxis:s,legend:{vAlign:"top",hAlign:"right",direction:"vertical"},tooltip:{formatter:function(t){return t.y}}}).cartesian().column(a,{stacked:!0}).tooltip();return e&&e.legend&&p.legend(a),p},ChartIncidentsByFieldByField.prototype.process=function(t){if(!(void 0===t||t.length<=0)&&t[0].value.id===this.getAggName(this.options.parameters.field1)&&"added"===t[0].status){var e=t[0].value.object.Items;_.each(e,function(t){t.DocCount=0,_.each(t.Aggregations[this.getAggName(this.options.parameters.field2)].Items,function(e){t.DocCount+=e.DocCount},this)},this),e=_.sortBy(e,function(t){return-1*t.DocCount});var o=function(){var t=[];return _.each(e,function(e){t.push({x:e.Key,y:0})}),t},i=[];_.each(e,function(t){_.each(t.Aggregations[this.getAggName(this.options.parameters.field2)].Items,function(e){var n=_.find(i,function(t){return t.name===e.Key});void 0===n&&(n={name:e.Key,data:o()},i.push(n));var a=_.find(n.data,function(e){return e.x===t.Key});a.y+=e.DocCount},this)},this),_.each(i,function(t){t.total=0,_.each(t.data,function(e){t.total+=e.y})}),i=_.sortBy(i,function(t){return-1*t.total}),this.chartData.push(i)}},ReportCover.prototype=new MappyComponent,ReportCover.prototype.initialize=function(t,e){this.mappy=t,this.titlecolor=this.mappy.options.incidentHighlightColor,this.translations=this.options.translations,this.contactemail=this.options.contactemail,this.fromDate="",this.toDate="",this.reportTitle=this.translations.covertitle,this.reportDate=this.formatDate(this._formatTimezoneDate(new Date,t.mappyState.clientTimezone)),this.searchvalue="",this.countriesvalue="",this.categoriesvalue="",this.regionsvalue="",this.sectorsvalue="",this.assettypesvalue="",this.attacktypesvalue="",this.damagevaluevalue="",this.severityscorevalue="",this.perpetratorsvalue="",this.riskratingsvalue="",void 0!==t.mappyState.dateFilterSetting&&(this.fromDate=this.formatDate(this._formatTimezoneDate(new Date(t.mappyState.dateFilterSetting.dateFrom),t.mappyState.clientTimezone)),this.toDate=this.formatDate(this._formatTimezoneDate(new Date(t.mappyState.dateFilterSetting.dateTo),t.mappyState.clientTimezone)));var o,i=this.options.slug;$.each(this.mappy.mappyState.itemFilterSetting,function(t,e){t===i&&(o=e)}),void 0!==o&&void 0!==o.selectedOptions&&(void 0!==o.selectedOptions["search.Description"]&&(this.searchvalue=o.selectedOptions["search.Description"].toString()),void 0!==o.selectedOptions["filters.CountryName"]&&(this.countriesvalue=o.selectedOptions["filters.CountryName"].join(", ")),void 0!==o.selectedOptions["filters.Region"]&&(this.regionsvalue=o.selectedOptions["filters.Region"].join(", ")),void 0!==o.selectedOptions["filters.Categories"]&&(this.categoriesvalue=o.selectedOptions["filters.Categories"].join(", ")),void 0!==o.selectedOptions["filters.Sectors"]&&(this.sectorsvalue=o.selectedOptions["filters.Sectors"].join(", ")),void 0!==o.selectedOptions["filters.AssetTypes"]&&(this.assettypesvalue=o.selectedOptions["filters.AssetTypes"].join(", ")),void 0!==o.selectedOptions["filters.AttackTypes"]&&(this.attacktypesvalue=o.selectedOptions["filters.AttackTypes"].join(", ")),void 0!==o.selectedOptions["filters.DamageValue"]&&(this.damagevaluevalue=o.selectedOptions["filters.DamageValue"].join(", ")),void 0!==o.selectedOptions["filters.SeverityScore"]&&(this.severityscorevalue=o.selectedOptions["filters.SeverityScore"].join(", ")),void 0!==o.selectedOptions["filters.Perpetrators"]&&(this.perpetratorsvalue=o.selectedOptions["filters.Perpetrators"].join(", "))),void 0!==this.mappy.mappyState.mapSetting.selectedRiskRatingLayer&&(this.riskratingsvalue=this.mappy.mappyState.mapSetting.selectedRiskRatingLayer),ko.applyBindings(this,document.getElementById(this.options.el)),e()},ReportCover.prototype._formatTimezoneDate=function(t,e){var o=t.getTime()+6e4*t.getTimezoneOffset();return new Date(o+36e5*e)},ReportCover.prototype.initialized=function(){},ReportCover.prototype.formatDate=function(t){var e=new Date(t);return("0"+e.getDate()).slice(-2)+"/"+("0"+(e.getMonth()+1)).slice(-2)+"/"+e.getFullYear()},ReportMapHeaderPanel.prototype=new MappyComponent,ReportMapHeaderPanel.prototype.initialize=function(t,e){this.translations=this.options.translations,ko.applyBindings(this,document.getElementById(this.options.el)),e()},ReportMapHeaderPanel.prototype.initialized=function(){};